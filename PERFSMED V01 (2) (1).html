<!DOCTYPE html>
<!--
PERFSMED V02 - Parallèle lanes
- Ajout des lanes (zones/opérateurs) avec migration V01 -> V02.
- Gantt parallèle par lane (cumul par lane, viewMode std/réel/both).
- KPI standard/réel basés sur le chemin critique (max des lanes).
- Exports JSON/CSV enrichis avec lanes + laneId.
-->
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PERFSMED V02 – Parallèle lanes</title>
<style>
:root {
  --bg:#0f1a34;
  --panel:#172447;
  --fg:#e8eefc;
  --accent:#3ddc97;
  --warn:#ffb703;
  --danger:#ef476f;
  --muted:#7b87a6;
  --shadow:0 20px 40px rgba(7,14,33,.55);
  --radius-xl:28px;
  --radius-lg:20px;
  --radius:14px;
  --radius-sm:10px;
  --focus:0 0 0 3px rgba(61,220,151,.35);
  color-scheme:dark;
}
* { box-sizing:border-box; }
html,body { height:100%; }
body {
  margin:0;
  font-family:"Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
  background:radial-gradient(140% 140% at 50% 0%,#1a2b55 0%,#0f1a34 45%,#09112a 100%);
  color:var(--fg);
}
button,input,select,textarea { font:inherit; color:inherit; }
button:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible, a:focus-visible {
  outline:3px solid var(--accent);
  outline-offset:2px;
}
.app {
  min-height:100%;
  display:grid;
  grid-template-rows:auto 1fr;
}
header {
  padding:20px clamp(16px,3vw,40px) 0;
}
.top-nav {
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
.brand {
  display:inline-flex;
  align-items:center;
  gap:12px;
  font-weight:700;
  letter-spacing:0.08em;
  text-transform:uppercase;
  color:var(--fg);
}
.brand-sep {
  width:1px;
  height:28px;
  background:rgba(232,238,252,.35);
}
.brand-line {
  font-size:1rem;
  letter-spacing:0.12em;
}
.header-actions {
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:12px;
  margin-left:auto;
}
main {
  padding:0 clamp(16px,3vw,40px) 40px;
  display:grid;
  gap:24px;
}
.panel {
  background:rgba(23,36,71,.86);
  border:1px solid rgba(255,255,255,.06);
  border-radius:var(--radius-xl);
  padding:24px;
  box-shadow:var(--shadow);
  backdrop-filter:blur(16px);
}
.panel.compact { padding:18px; border-radius:var(--radius-lg); }
.panel-title {
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:16px;
  margin-bottom:18px;
}
.panel-title h2 {
  margin:0;
  font-size:1.1rem;
  letter-spacing:.02em;
}
.grid-two {
  display:grid;
  gap:16px;
}
@media (min-width:960px) {
  .grid-two {
    grid-template-columns: minmax(0,1.2fr) minmax(0,0.8fr);
  }
}
.field label {
  display:grid;
  gap:6px;
  font-size:0.76rem;
  text-transform:uppercase;
  letter-spacing:0.08em;
  color:var(--muted);
}
.field input, .field select {
  border-radius:var(--radius);
  border:1px solid rgba(255,255,255,.12);
  background:rgba(15,26,52,.65);
  padding:12px 14px;
  min-height:44px;
}
button {
  border-radius:var(--radius);
  border:none;
  padding:12px 18px;
  font-weight:600;
  cursor:pointer;
  min-height:44px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  transition:transform .2s ease, background .2s ease;
}
button.primary {
  background:var(--accent);
  color:#021221;
  font-weight:700;
}
button.secondary {
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.16);
  color:var(--fg);
}
button.ghost { background:transparent; border:1px solid rgba(255,255,255,.18); }
button:disabled {
  cursor:not-allowed;
  opacity:.5;
  transform:none !important;
}
button:not(:disabled):active { transform:translateY(1px); }
.badge {
  border-radius:999px;
  padding:6px 12px;
  font-size:0.75rem;
  letter-spacing:0.08em;
  text-transform:uppercase;
  background:rgba(255,255,255,.12);
  color:var(--muted);
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.actions-row {
  display:flex;
  flex-wrap:wrap;
  gap:12px;
}
.chip-row {
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.chip {
  padding:10px 16px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.1);
  background:rgba(255,255,255,.06);
  cursor:pointer;
}
.chip.active {
  background:var(--accent);
  color:#021221;
  border-color:transparent;
}
.kpi-grid { display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); }
.kpi-card { background:rgba(9,18,40,.7); border-radius:var(--radius-lg); padding:16px; border:1px solid rgba(255,255,255,.08); display:grid; gap:6px; }
.kpi-card strong { font-size:1.3rem; font-variant-numeric:tabular-nums; }
.log-table-wrapper {
  max-height:420px;
  overflow:auto;
  border-radius:var(--radius-lg);
  border:1px solid rgba(255,255,255,.1);
}
table { width:100%; border-collapse:collapse; font-size:0.9rem; }
th,td {
  padding:10px 12px;
  border-bottom:1px solid rgba(255,255,255,.05);
}
th {
  position:sticky;
  top:0;
  background:rgba(12,22,46,.95);
  text-align:left;
  font-size:0.75rem;
  letter-spacing:0.08em;
  text-transform:uppercase;
}
tbody tr:hover { background:rgba(255,255,255,.04); }

.gantt-panel {
  display:grid;
  gap:16px;
}
.gantt-axis {
  position:relative;
  height:34px;
  background:rgba(9,18,40,.6);
  border-radius:var(--radius-sm);
  border:1px solid rgba(255,255,255,.08);
  overflow:hidden;
}
.gantt-axis .tick {
  position:absolute;
  top:0;
  width:1px;
  height:100%;
  background:rgba(255,255,255,.12);
}
.gantt-axis .tick-label {
  position:absolute;
  top:6px;
  transform:translateX(-50%);
  font-size:0.7rem;
  color:var(--muted);
  white-space:nowrap;
}
.gantt-grid {
  display:grid;
  gap:10px;
}
.gantt-lane {
  background:rgba(9,18,40,.6);
  border:1px solid rgba(255,255,255,.08);
  border-radius:var(--radius-lg);
  padding:12px;
  display:grid;
  gap:10px;
}
.gantt-lane-header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  font-size:0.85rem;
  text-transform:uppercase;
  letter-spacing:0.08em;
  color:var(--muted);
}
.gantt-row {
  position:relative;
  min-height:38px;
  background:rgba(15,26,52,.55);
  border-radius:var(--radius-sm);
  border:1px solid rgba(255,255,255,.06);
  overflow:hidden;
}
.gantt-row .bar {
  position:absolute;
  top:6px;
  height:24px;
  border-radius:999px;
  display:flex;
  align-items:center;
  gap:8px;
  padding:0 10px;
  font-size:0.8rem;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  cursor:pointer;
}
.gantt-row .bar.std { background:rgba(61,220,151,.65); color:#021221; }
.gantt-row .bar.real { background:rgba(255,183,3,.7); color:#051933; }
.gantt-row .bar.both { box-shadow:0 0 0 1px rgba(255,255,255,.2) inset; }
.gantt-row .bar.status-pending {
  opacity:0.6;
  border:1px dashed rgba(255,255,255,.35);
}
.gantt-row .bar.status-progress {
  box-shadow:0 0 0 2px rgba(61,220,151,.6) inset, 0 0 12px rgba(61,220,151,.2);
}
.gantt-row .bar.status-done {
  box-shadow:0 0 0 2px rgba(61,220,151,.9) inset;
  filter:saturate(1.15);
}
.gantt-row .bar .label {
  font-weight:600;
}
.gantt-row .bar .time {
  font-size:0.7rem;
  opacity:0.85;
}
.gantt-row .grid-line {
  position:absolute;
  top:0;
  width:1px;
  height:100%;
  background:rgba(255,255,255,.08);
}
.gantt-lane-body {
  overflow-x:auto;
  padding-bottom:6px;
}
.gantt-lane-content {
  min-width:100%;
  display:grid;
  gap:10px;
}
.modal-backdrop {
  position:fixed;
  inset:0;
  background:rgba(5,10,24,.65);
  display:none;
  align-items:center;
  justify-content:center;
  padding:24px;
  z-index:50;
}
.modal-backdrop.active { display:flex; }
.modal {
  background:rgba(15,26,52,.95);
  border:1px solid rgba(255,255,255,.08);
  border-radius:var(--radius-lg);
  padding:24px;
  width:min(520px, 92vw);
  box-shadow:var(--shadow);
  position:relative;
  display:grid;
  gap:16px;
}
.modal h3 {
  margin:0;
  font-size:1.05rem;
}
.modal-meta {
  display:grid;
  gap:6px;
  color:var(--muted);
  font-size:0.85rem;
}
.modal-actions {
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}
.modal-close {
  position:absolute;
  top:14px;
  right:16px;
  width:36px;
  height:36px;
  border-radius:50%;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.12);
  font-size:1.1rem;
}
.modal-message {
  font-size:0.85rem;
  color:var(--warn);
}
.small-note { color:var(--muted); font-size:0.8rem; }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="top-nav">
      <div class="brand">
        <span>SMED L29</span>
        <span class="brand-sep"></span>
        <span class="brand-line">PERFSMED V02</span>
      </div>
      <div class="header-actions">
        <button type="button" class="secondary" id="resetState">Réinitialiser</button>
        <button type="button" class="ghost" id="exportJson">Exporter JSON</button>
        <button type="button" class="ghost" id="exportCsv">Exporter CSV</button>
      </div>
    </div>
  </header>
  <main>
    <section class="panel">
      <div class="panel-title">
        <h2>Paramètres & KPI</h2>
        <span class="badge">LocalStorage: PERFSMED_V01_STATE</span>
      </div>
      <div class="grid-two">
        <div class="panel compact">
          <div class="panel-title">
            <h2>Entrées</h2>
          </div>
          <div class="grid-two">
            <div class="field">
              <label>IPC First (min)</label>
              <input type="number" min="0" step="0.1" id="ipcFirst" />
            </div>
            <div class="field">
              <label>IPC Last (min)</label>
              <input type="number" min="0" step="0.1" id="ipcLast" />
            </div>
          </div>
          <div style="margin-top:16px" class="chip-row" role="tablist">
            <button type="button" class="chip active" data-view="both">Std + Réel</button>
            <button type="button" class="chip" data-view="std">Std seulement</button>
            <button type="button" class="chip" data-view="real">Réel seulement</button>
          </div>
        </div>
        <div class="panel compact">
          <div class="panel-title">
            <h2>KPI</h2>
          </div>
          <div class="kpi-grid">
            <div class="kpi-card">
              <span class="small-note">Durée parallèle standard (chemin critique)</span>
              <strong id="kpiStd">0</strong>
            </div>
            <div class="kpi-card">
              <span class="small-note">Durée parallèle réelle (chemin critique)</span>
              <strong id="kpiReal">0</strong>
            </div>
            <div class="kpi-card">
              <span class="small-note">Inter-PO (IPC Last - IPC First)</span>
              <strong id="kpiInter">0</strong>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="panel gantt-panel">
      <div class="panel-title">
        <h2>Gantt parallèle par lane</h2>
        <span class="small-note" id="ganttHint"></span>
      </div>
      <div class="gantt-axis" id="ganttAxis"></div>
      <div class="gantt-grid" id="ganttGrid"></div>
    </section>

    <section class="panel">
      <div class="panel-title">
        <h2>Journal des actions</h2>
        <div class="actions-row">
          <button type="button" class="primary" id="addAction">Ajouter action</button>
        </div>
      </div>
      <div class="log-table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Ordre</th>
              <th>Action</th>
              <th>Lane</th>
              <th>Std (min)</th>
              <th>Réel (min)</th>
              <th>Notes</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="actionsTable"></tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<div class="modal-backdrop" id="actionModal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <button type="button" class="modal-close" id="modalClose" aria-label="Fermer">×</button>
    <h3 id="modalTitle">Action</h3>
    <div class="modal-meta" id="modalMeta"></div>
    <div class="field" id="modalJustificationField" style="display:none;">
      <label>Justification (obligatoire en cas de dépassement)</label>
      <textarea id="modalJustification" rows="4" placeholder="Expliquez la raison du dépassement..."></textarea>
    </div>
    <div class="modal-message" id="modalMessage"></div>
    <div class="modal-actions" id="modalActions"></div>
  </div>
</div>

<script>
(() => {
  const STORAGE_KEY = 'PERFSMED_V01_STATE';
  const DEFAULT_LANES = [
    { id: 'Z1', name: 'Zone A' },
    { id: 'Z2', name: 'Zone B' }
  ];

  const els = {
    ipcFirst: document.getElementById('ipcFirst'),
    ipcLast: document.getElementById('ipcLast'),
    kpiStd: document.getElementById('kpiStd'),
    kpiReal: document.getElementById('kpiReal'),
    kpiInter: document.getElementById('kpiInter'),
    ganttAxis: document.getElementById('ganttAxis'),
    ganttGrid: document.getElementById('ganttGrid'),
    ganttHint: document.getElementById('ganttHint'),
    actionsTable: document.getElementById('actionsTable'),
    addAction: document.getElementById('addAction'),
    exportJson: document.getElementById('exportJson'),
    exportCsv: document.getElementById('exportCsv'),
    resetState: document.getElementById('resetState'),
    viewButtons: Array.from(document.querySelectorAll('[data-view]')),
    actionModal: document.getElementById('actionModal'),
    modalTitle: document.getElementById('modalTitle'),
    modalMeta: document.getElementById('modalMeta'),
    modalJustificationField: document.getElementById('modalJustificationField'),
    modalJustification: document.getElementById('modalJustification'),
    modalMessage: document.getElementById('modalMessage'),
    modalActions: document.getElementById('modalActions'),
    modalClose: document.getElementById('modalClose')
  };

  const defaultState = () => ({
    viewMode: 'both',
    ipcFirst: 0,
    ipcLast: 0,
    lanes: [...DEFAULT_LANES],
    actions: [
      { id: 'A1', name: 'Sécuriser ligne', stdMin: 8, realMin: 9, notes: '', order: 1, laneId: 'Z1', status: 'pending', justification: '', startedAt: null, finishedAt: null },
      { id: 'A2', name: 'Nettoyage rapide', stdMin: 12, realMin: 11, notes: '', order: 2, laneId: 'Z2', status: 'pending', justification: '', startedAt: null, finishedAt: null },
      { id: 'A3', name: 'Changement format', stdMin: 15, realMin: 14, notes: '', order: 3, laneId: 'Z1', status: 'pending', justification: '', startedAt: null, finishedAt: null },
      { id: 'A4', name: 'Redémarrage convoyeur', stdMin: 6, realMin: '', notes: '', order: 4, laneId: 'Z2', status: 'pending', justification: '', startedAt: null, finishedAt: null }
    ]
  });

  let state = loadState();

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return defaultState();
      const parsed = JSON.parse(raw);
      const migrated = migrateState(parsed);
      return migrated;
    } catch (err) {
      console.warn('State load failed, fallback default.', err);
      return defaultState();
    }
  }

  function migrateState(st) {
    const migrated = { ...defaultState(), ...st };
    if (!Array.isArray(migrated.lanes) || migrated.lanes.length === 0) {
      migrated.lanes = [...DEFAULT_LANES];
    }
    migrated.actions = Array.isArray(migrated.actions) ? migrated.actions.map(action => ({
      id: action.id || newId(),
      name: action.name || '',
      stdMin: Number(action.stdMin) || 0,
      realMin: action.realMin === '' || action.realMin == null ? '' : Number(action.realMin) || 0,
      notes: action.notes || '',
      order: Number(action.order) || 0,
      laneId: action.laneId && String(action.laneId).trim() ? String(action.laneId).trim() : 'Z1',
      // Champs interactifs (migration rétrocompatible)
      status: ['pending', 'in_progress', 'done'].includes(action.status) ? action.status : 'pending',
      justification: action.justification || '',
      startedAt: action.startedAt || null,
      finishedAt: action.finishedAt || null
    })) : [];
    return migrated;
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function newId() {
    return `A${Math.random().toString(36).slice(2, 9)}`;
  }

  function formatMinutes(value) {
    const num = Number(value) || 0;
    return `${num.toFixed(1)} min`;
  }

  function getLaneTotals(actions, lanes) {
    const totals = {};
    lanes.forEach(lane => {
      totals[lane.id] = { std: 0, real: 0 };
    });
    actions.forEach(action => {
      const laneId = action.laneId || 'Z1';
      if (!totals[laneId]) totals[laneId] = { std: 0, real: 0 };
      const std = Number(action.stdMin) || 0;
      const real = action.realMin === '' || action.realMin == null ? std : Number(action.realMin) || 0;
      totals[laneId].std += std;
      totals[laneId].real += real;
    });
    return totals;
  }

  function computeMaxDuration(totals) {
    let max = 0;
    Object.values(totals).forEach(item => {
      max = Math.max(max, item.std, item.real);
    });
    return max || 1;
  }

  function renderAxis(maxDuration) {
    els.ganttAxis.innerHTML = '';
    const ticks = maxDuration <= 20 ? 4 : maxDuration <= 60 ? 6 : 8;
    for (let i = 0; i <= ticks; i += 1) {
      const pct = (i / ticks) * 100;
      const tick = document.createElement('div');
      tick.className = 'tick';
      tick.style.left = `${pct}%`;
      const label = document.createElement('div');
      label.className = 'tick-label';
      label.style.left = `${pct}%`;
      label.textContent = `${Math.round((maxDuration * i) / ticks)} min`;
      els.ganttAxis.appendChild(tick);
      els.ganttAxis.appendChild(label);
    }
  }

  function renderGantt() {
    const actions = [...state.actions].sort((a, b) => (a.order || 0) - (b.order || 0));
    const lanes = state.lanes.length ? state.lanes : DEFAULT_LANES;
    const totals = getLaneTotals(actions, lanes);
    const maxDuration = computeMaxDuration(totals);
    renderAxis(maxDuration);
    els.ganttGrid.innerHTML = '';

    const viewMode = state.viewMode || 'both';
    els.ganttHint.textContent = `Mode: ${viewMode === 'both' ? 'Std + Réel' : viewMode === 'std' ? 'Std' : 'Réel'}`;

    lanes.forEach(lane => {
      const laneId = lane.id;
      const laneActions = actions.filter(action => (action.laneId || 'Z1') === laneId);
      const laneEl = document.createElement('div');
      laneEl.className = 'gantt-lane';

      const header = document.createElement('div');
      header.className = 'gantt-lane-header';
      const totalsLabel = `Std ${totals[laneId]?.std || 0} min · Réel ${totals[laneId]?.real || 0} min`;
      header.innerHTML = `<span>${lane.name} (${lane.id})</span><span>${totalsLabel}</span>`;
      laneEl.appendChild(header);

      const laneBody = document.createElement('div');
      laneBody.className = 'gantt-lane-body';
      const laneContent = document.createElement('div');
      laneContent.className = 'gantt-lane-content';
      laneContent.style.width = `${Math.max(100, maxDuration * 14)}px`;

      let stdCursor = 0;
      let realCursor = 0;

      if (!laneActions.length) {
        const empty = document.createElement('div');
        empty.className = 'gantt-row';
        empty.innerHTML = '<span class="small-note" style="padding:8px 10px; display:inline-block;">Aucune action</span>';
        laneContent.appendChild(empty);
      }

      laneActions.forEach(action => {
        const stdMin = Number(action.stdMin) || 0;
        const realMin = action.realMin === '' || action.realMin == null ? null : Number(action.realMin) || 0;
        const realValue = realMin == null ? stdMin : realMin;
        const statusClass = `status-${action.status || 'pending'}`;

        const row = document.createElement('div');
        row.className = 'gantt-row';

        const ticks = 6;
        for (let i = 0; i <= ticks; i += 1) {
          const line = document.createElement('div');
          line.className = 'grid-line';
          line.style.left = `${(i / ticks) * 100}%`;
          row.appendChild(line);
        }

        if (viewMode === 'std' || viewMode === 'both') {
          const bar = document.createElement('div');
          bar.className = `bar std ${statusClass} ${viewMode === 'both' ? 'both' : ''}`;
          bar.style.left = `${(stdCursor / maxDuration) * 100}%`;
          bar.style.width = `${(stdMin / maxDuration) * 100}%`;
          bar.innerHTML = `<span class="label">${escapeHtml(action.name)}</span><span class="time">${stdMin} min</span>`;
          bar.dataset.actionId = action.id;
          bar.dataset.barType = 'std';
          bar.addEventListener('click', () => openModal(action.id));
          row.appendChild(bar);
        }

        if (viewMode === 'real' || viewMode === 'both') {
          const bar = document.createElement('div');
          bar.className = `bar real ${statusClass} ${viewMode === 'both' ? 'both' : ''}`;
          bar.style.left = `${(realCursor / maxDuration) * 100}%`;
          bar.style.width = `${(realValue / maxDuration) * 100}%`;
          bar.style.top = viewMode === 'both' ? '18px' : '6px';
          bar.innerHTML = `<span class="label">${escapeHtml(action.name)}</span><span class="time">${realValue} min</span>`;
          bar.dataset.actionId = action.id;
          bar.dataset.barType = 'real';
          bar.addEventListener('click', () => openModal(action.id));
          row.appendChild(bar);
        }

        stdCursor += stdMin;
        realCursor += realValue;
        laneContent.appendChild(row);
      });

      laneBody.appendChild(laneContent);
      laneEl.appendChild(laneBody);
      els.ganttGrid.appendChild(laneEl);
    });
  }

  function renderTable() {
    els.actionsTable.innerHTML = '';
    const actions = [...state.actions].sort((a, b) => (a.order || 0) - (b.order || 0));
    actions.forEach(action => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${action.order || 0}</td>
        <td>${escapeHtml(action.name)}</td>
        <td>${escapeHtml(action.laneId || 'Z1')}</td>
        <td>${Number(action.stdMin) || 0}</td>
        <td>${action.realMin === '' || action.realMin == null ? '—' : Number(action.realMin) || 0}</td>
        <td>${escapeHtml(action.notes || '')}</td>
        <td>
          <button type="button" class="ghost" data-action="edit" data-id="${action.id}">Éditer</button>
          <button type="button" class="ghost" data-action="delete" data-id="${action.id}">Suppr.</button>
        </td>
      `;
      row.querySelector('[data-action="edit"]').addEventListener('click', () => editAction(action.id));
      row.querySelector('[data-action="delete"]').addEventListener('click', () => deleteAction(action.id));
      els.actionsTable.appendChild(row);
    });
  }

  function updateKpis() {
    const totals = getLaneTotals(state.actions, state.lanes);
    const maxStd = Math.max(0, ...Object.values(totals).map(item => item.std));
    const maxReal = Math.max(0, ...Object.values(totals).map(item => item.real));
    const inter = Math.max(0, (Number(state.ipcLast) || 0) - (Number(state.ipcFirst) || 0));

    els.kpiStd.textContent = formatMinutes(maxStd);
    els.kpiReal.textContent = formatMinutes(maxReal);
    els.kpiInter.textContent = formatMinutes(inter);
  }

  function refreshUI() {
    els.ipcFirst.value = state.ipcFirst || 0;
    els.ipcLast.value = state.ipcLast || 0;
    els.viewButtons.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.view === state.viewMode);
    });
    renderGantt();
    renderTable();
    updateKpis();
  }

  function addAction() {
    const name = prompt('Nom de l\'action ?');
    if (!name) return;
    const stdMin = Number(prompt('Temps standard (min) ?') || 0) || 0;
    const realInput = prompt('Temps réel (min) ? Laisser vide si non saisi.');
    const realMin = realInput == null || realInput.trim() === '' ? '' : Number(realInput) || 0;
    const laneId = (prompt('Lane ID ? (ex: Z1)') || 'Z1').trim() || 'Z1';
    const notes = prompt('Notes (optionnel) ?') || '';
    const order = Number(prompt('Ordre ?') || (state.actions.length + 1)) || state.actions.length + 1;

    state.actions.push({
      id: newId(),
      name: name.trim(),
      stdMin,
      realMin,
      notes: notes.trim(),
      order,
      laneId,
      status: 'pending',
      justification: '',
      startedAt: null,
      finishedAt: null
    });
    saveAndRefresh();
  }

  function editAction(id) {
    const action = state.actions.find(item => item.id === id);
    if (!action) return;
    const name = prompt('Nom de l\'action ?', action.name);
    if (name == null || name.trim() === '') return;
    const stdMin = Number(prompt('Temps standard (min) ?', action.stdMin) || 0) || 0;
    const realInput = prompt('Temps réel (min) ? Laisser vide si non saisi.', action.realMin === '' || action.realMin == null ? '' : action.realMin);
    const realMin = realInput == null || String(realInput).trim() === '' ? '' : Number(realInput) || 0;
    const laneId = (prompt('Lane ID ? (ex: Z1)', action.laneId || 'Z1') || 'Z1').trim() || 'Z1';
    const notes = prompt('Notes (optionnel) ?', action.notes || '') || '';
    const order = Number(prompt('Ordre ?', action.order) || action.order) || action.order;

    action.name = name.trim();
    action.stdMin = stdMin;
    action.realMin = realMin;
    action.laneId = laneId;
    action.notes = notes.trim();
    action.order = order;
    saveAndRefresh();
  }

  function deleteAction(id) {
    if (!confirm('Supprimer cette action ?')) return;
    state.actions = state.actions.filter(action => action.id !== id);
    saveAndRefresh();
  }

  function exportJson() {
    const payload = JSON.stringify(state, null, 2);
    downloadBlob(payload, 'PERFSMED_V02.json', 'application/json');
  }

  function exportCsv() {
    const headers = ['id', 'name', 'laneId', 'stdMin', 'realMin', 'notes', 'order', 'status', 'justification', 'startedAt', 'finishedAt'];
    const rows = state.actions.map(action => [
      action.id,
      action.name,
      action.laneId || 'Z1',
      Number(action.stdMin) || 0,
      action.realMin === '' || action.realMin == null ? '' : Number(action.realMin) || 0,
      action.notes || '',
      action.order || 0,
      action.status || 'pending',
      action.justification || '',
      action.startedAt || '',
      action.finishedAt || ''
    ]);
    const lines = [headers.join(';'), ...rows.map(row => row.map(escapeCsv).join(';'))].join('\n');
    downloadBlob(lines, 'PERFSMED_V02.csv', 'text/csv');
  }

  function downloadBlob(content, filename, type) {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    link.remove();
    URL.revokeObjectURL(url);
  }

  function escapeCsv(value) {
    const safe = String(value ?? '').replace(/\"/g, '""');
    if (/[";\n]/.test(safe)) {
      return `"${safe}"`;
    }
    return safe;
  }

  function escapeHtml(value) {
    return String(value || '').replace(/[&<>"']/g, char => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    }[char]));
  }

  function saveAndRefresh() {
    saveState();
    refreshUI();
  }

  function getActionRealValue(action) {
    return action.realMin === '' || action.realMin == null ? Number(action.stdMin) || 0 : Number(action.realMin) || 0;
  }

  function requiresJustification(action) {
    const std = Number(action.stdMin) || 0;
    const real = getActionRealValue(action);
    return real > std;
  }

  function renderModal(action) {
    const lane = state.lanes.find(item => item.id === (action.laneId || 'Z1'));
    const laneLabel = lane ? `${lane.name} (${lane.id})` : action.laneId || 'Z1';
    const std = Number(action.stdMin) || 0;
    const real = getActionRealValue(action);

    els.modalTitle.textContent = `${action.name || 'Action'} — ${laneLabel}`;
    els.modalMeta.innerHTML = `
      <div>Statut: <strong>${action.status || 'pending'}</strong></div>
      <div>Std: ${std} min · Réel: ${real} min</div>
    `;
    els.modalMessage.textContent = '';
    els.modalJustification.value = action.justification || '';

    const showJustification = action.status === 'done' || Boolean(action.justification);
    els.modalJustificationField.style.display = showJustification ? 'grid' : 'none';

    els.modalActions.innerHTML = '';
    if (action.status === 'pending') {
      addModalButton('Démarrer', 'secondary', () => updateActionStatus(action.id, 'in_progress'));
      addModalButton('Marquer terminé', 'primary', () => updateActionStatus(action.id, 'done'));
    } else if (action.status === 'in_progress') {
      addModalButton('Marquer terminé', 'primary', () => updateActionStatus(action.id, 'done'));
    } else {
      addModalButton('Repasser en cours', 'secondary', () => updateActionStatus(action.id, 'in_progress'));
      addModalButton('Réinitialiser', 'ghost', () => updateActionStatus(action.id, 'pending'));
    }
  }

  function addModalButton(label, styleClass, handler) {
    const button = document.createElement('button');
    button.type = 'button';
    button.className = styleClass;
    button.textContent = label;
    button.addEventListener('click', handler);
    els.modalActions.appendChild(button);
  }

  function openModal(actionId) {
    const action = state.actions.find(item => item.id === actionId);
    if (!action) return;
    els.actionModal.dataset.actionId = actionId;
    renderModal(action);
    els.actionModal.classList.add('active');
    els.actionModal.setAttribute('aria-hidden', 'false');
  }

  function closeModal() {
    els.actionModal.classList.remove('active');
    els.actionModal.setAttribute('aria-hidden', 'true');
    els.modalMessage.textContent = '';
    els.modalJustification.value = '';
  }

  function updateActionStatus(actionId, nextStatus) {
    const action = state.actions.find(item => item.id === actionId);
    if (!action) return;

    if (nextStatus === 'done') {
      if (requiresJustification(action)) {
        const justification = els.modalJustification.value.trim();
        if (!justification) {
          els.modalMessage.textContent = 'Justification obligatoire : merci de préciser la raison du dépassement.';
          els.modalJustificationField.style.display = 'grid';
          return;
        }
        action.justification = justification;
      }
      action.status = 'done';
      action.finishedAt = new Date().toISOString();
    } else if (nextStatus === 'in_progress') {
      action.status = 'in_progress';
      action.startedAt = action.startedAt || new Date().toISOString();
      action.finishedAt = null;
    } else {
      action.status = 'pending';
      action.startedAt = null;
      action.finishedAt = null;
      action.justification = '';
    }

    saveAndRefresh();
    renderModal(action);
  }

  function resetAll() {
    if (!confirm('Réinitialiser toutes les données ?')) return;
    state = defaultState();
    saveAndRefresh();
  }

  function bindEvents() {
    els.ipcFirst.addEventListener('input', () => {
      state.ipcFirst = Number(els.ipcFirst.value) || 0;
      saveAndRefresh();
    });
    els.ipcLast.addEventListener('input', () => {
      state.ipcLast = Number(els.ipcLast.value) || 0;
      saveAndRefresh();
    });
    els.viewButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        state.viewMode = btn.dataset.view;
        saveAndRefresh();
      });
    });
    els.addAction.addEventListener('click', addAction);
    els.exportJson.addEventListener('click', exportJson);
    els.exportCsv.addEventListener('click', exportCsv);
    els.resetState.addEventListener('click', resetAll);
    els.modalClose.addEventListener('click', closeModal);
    els.actionModal.addEventListener('click', event => {
      if (event.target === els.actionModal) closeModal();
    });
    document.addEventListener('keydown', event => {
      if (event.key === 'Escape' && els.actionModal.classList.contains('active')) {
        closeModal();
      }
    });
  }

  bindEvents();
  refreshUI();
})();
</script>
</body>
</html>
