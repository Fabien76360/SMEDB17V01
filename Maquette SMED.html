<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Maquette SMED</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #f5f7fb;
      --surface: #ffffff;
      --surface-muted: #eef2f7;
      --text: #152033;
      --text-muted: #5b6a82;
      --primary: #1f4b99;
      --chrono-ok: #2f8a57;
      --chrono-warn: #d6a020;
      --chrono-over: #c75757;
      --chrono-over-base: #f8e9e9;
      --reset-bg: #fdeeee;
      --reset-border: rgba(161, 72, 72, 0.35);
      --reset-text: #7b2b2b;
      --border: rgba(21, 32, 51, 0.16);
      --shadow: 0 8px 24px rgba(21, 32, 51, 0.08);
      --radius: 18px;
      --focus: #ffbf3f;
      --header-height: 72px;
      --tabbar-height: 64px;
      --sticky-top: calc(var(--header-height) + var(--tabbar-height) + 8px);
    }

    body[data-theme="high-contrast"] {
      --bg: #0b0b0b;
      --surface: #111111;
      --surface-muted: #1f1f1f;
      --text: #ffffff;
      --text-muted: #d5d5d5;
      --primary: #ffd84a;
      --chrono-ok: #7df4a8;
      --chrono-warn: #ffd84a;
      --chrono-over: #ff8d8d;
      --chrono-over-base: #2a1212;
      --reset-bg: #2a1212;
      --reset-border: rgba(255, 216, 74, 0.7);
      --reset-text: #ffd84a;
      --border: rgba(255, 255, 255, 0.5);
      --shadow: 0 10px 28px rgba(0, 0, 0, 0.6);
      --focus: #ffd84a;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      height: var(--header-height);
      padding: 10px 24px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 4px;
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow);
      z-index: 20;
    }

    header h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.4px;
    }

    header p {
      margin: 0;
      color: var(--text-muted);
      font-size: 14px;
    }

    .subtitle-line {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: baseline;
    }

    .datetime-inline {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-variant-numeric: tabular-nums;
      letter-spacing: 0.4px;
      min-width: 170px;
      display: inline-block;
    }

    main {
      padding: calc(var(--header-height) + var(--tabbar-height) + 16px) 20px 32px;
      min-height: 100vh;
    }

    @media (max-height: 700px) {
      :root {
        --header-height: 60px;
        --tabbar-height: 56px;
      }

      header {
        padding: 8px 20px;
      }

      header h1 {
        font-size: 20px;
      }

      .datetime-inline {
        min-width: 160px;
      }

      main {
        padding: calc(var(--header-height) + var(--tabbar-height) + 12px) 16px 24px;
      }
    }

    .page {
      display: none;
      animation: fadeIn 0.2s ease-in;
    }

    .page.active {
      display: block;
    }

    .page h2 {
      font-size: 24px;
      margin-bottom: 12px;
    }

    .id-block {
      display: grid;
      gap: 12px;
      grid-template-columns: minmax(180px, 1.2fr) minmax(220px, 2fr) minmax(160px, 1fr) minmax(130px, 0.8fr) minmax(150px, 0.7fr);
      grid-template-areas: "ligne po ipc-date ipc-time actions";
      margin-bottom: 16px;
      max-width: 1200px;
    }

    .id-block > * {
      min-width: 0;
    }

    .field.ligne {
      grid-area: ligne;
    }

    .field.po {
      grid-area: po;
    }

    .field.date {
      grid-area: ipc-date;
    }

    .field.time {
      grid-area: ipc-time;
    }

    .field.actions-field {
      grid-area: actions;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .field label {
      font-size: 15px;
      font-weight: 600;
    }

    .field input {
      height: 44px;
      min-height: 44px;
      padding: 0 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-size: 16px;
    }

    .field input[type="date"],
    .field input[type="time"] {
      font-variant-numeric: tabular-nums;
    }

    .field.wide,
    .field.date,
    .field.time,
    .field.actions-field {
      width: 100%;
    }

    .actions-wrap {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      width: 100%;
    }

    .actions-wrap > * {
      min-width: 0;
    }

    .field input::placeholder {
      color: var(--text-muted);
    }

    .field input:focus-visible {
      outline: 3px solid var(--focus);
      outline-offset: 2px;
    }

    .reset-button {
      height: 44px;
      min-height: 44px;
      padding: 0 14px;
      border-radius: 12px;
      border: 1px solid var(--reset-border);
      background: var(--reset-bg);
      color: var(--reset-text);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.15s ease;
      flex: 0 0 auto;
      white-space: nowrap;
    }

    .reset-button:active {
      transform: scale(0.98);
    }

    .reset-button:focus-visible {
      outline: 3px solid var(--focus);
      outline-offset: 2px;
    }

    .chrono-card {
      position: relative;
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 18px 16px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: var(--surface-muted);
      min-height: 44px;
      flex: 1 1 auto;
      width: 100%;
      min-width: 0;
      overflow: hidden;
      isolation: isolate;
    }

    .chrono-bar {
      position: sticky;
      top: var(--sticky-top);
      z-index: 50;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 12px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
    }

    .chrono-bar .chrono-card {
      flex: 1 1 auto;
      width: 100%;
    }

    .chrono-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: var(--chrono-progress-color);
      opacity: 0.35;
      transform-origin: left;
      transform: scaleX(var(--chrono-progress, 0));
      transition: transform 0.25s ease;
      z-index: 0;
    }

    .chrono-card.state-ok {
      --chrono-progress-color: var(--chrono-ok);
    }

    .chrono-card.state-warn {
      --chrono-progress-color: var(--chrono-warn);
    }

    .chrono-card.state-over {
      --chrono-progress-color: var(--chrono-over);
      background: var(--chrono-over-base);
    }

    .chrono-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
      z-index: 1;
    }

    .chrono-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--text-muted);
      font-weight: 600;
    }

    .chrono-time {
      font-size: 30px;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }

    .chrono-status {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      letter-spacing: 0.4px;
    }

    .chrono-metrics {
      margin-left: auto;
      display: flex;
      gap: 8px;
      z-index: 1;
    }

    .chrono-metric {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px 8px;
      min-width: 74px;
      text-align: center;
      font-size: 11px;
    }

    .chrono-metric span {
      display: block;
      font-weight: 600;
      font-size: 12px;
      margin-top: 2px;
    }

    @media (max-width: 980px) {
      .id-block {
        grid-template-columns: minmax(180px, 1.2fr) minmax(220px, 2fr) minmax(140px, 1fr);
        grid-template-areas:
          "ligne po actions"
          "ipc-date ipc-time .";
        max-width: none;
      }

      .actions-wrap {
        justify-content: flex-start;
        flex-wrap: wrap;
      }

      .chrono-card {
        flex: 1 1 100%;
      }
    }

    @media (max-width: 620px) {
      .id-block {
        grid-template-columns: 1fr;
        grid-template-areas:
          "ligne"
          "po"
          "ipc-date"
          "ipc-time"
          "actions";
      }

      .actions-wrap {
        flex-direction: column;
        align-items: stretch;
      }

      .reset-button {
        width: 100%;
      }

      .chrono-metrics {
        margin-left: 0;
      }

      .chrono-card {
        width: 100%;
      }
    }

    .inline-status {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface-muted);
      color: var(--text);
      font-size: 14px;
      max-width: 360px;
    }

    .inline-status.visible {
      display: inline-flex;
    }

    .inline-status .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--primary);
    }

    .operators-section {
      margin-top: 20px;
    }

    .operators-section h3 {
      margin: 0 0 12px;
      font-size: 20px;
    }

    .operators-grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    .operator-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 16px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .operator-card[data-status="done"] {
      opacity: 0.78;
      transform: scale(0.98);
    }

    .operator-card[data-status="done"] .operator-actions,
    .operator-card[data-status="done"] .operator-chips {
      gap: 6px;
    }

    .operator-card[data-status="done"] .operator-footer {
      margin-top: -2px;
    }

    .operator-card[data-status="running"] {
      opacity: 1;
      transform: none;
    }

    .operator-card[data-status="running"] .operator-actions .primary {
      box-shadow: 0 8px 18px rgba(31, 75, 153, 0.35);
    }

    .operator-card.inactive {
      opacity: 0.6;
    }

    .operator-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .operator-name {
      font-size: 16px;
      font-weight: 700;
    }

    .operator-status {
      font-size: 12px;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--surface-muted);
      border: 1px solid var(--border);
    }

    .operator-status.todo {
      color: var(--text-muted);
    }

    .operator-status.running {
      color: var(--primary);
    }

    .operator-status.done {
      color: #2f8a57;
    }

    .operator-status.over {
      color: #c75757;
    }

    .operator-step {
      display: grid;
      gap: 6px;
      font-size: 14px;
    }

    .operator-step strong {
      font-size: 15px;
    }

    .operator-chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chip {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--surface-muted);
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    .chip.muted {
      opacity: 0.6;
    }

    .operator-card[data-status="running"] .chip {
      color: var(--text);
    }

    .operator-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .operator-actions button {
      height: 44px;
      min-height: 44px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface-muted);
      color: var(--text);
      font-size: 14px;
      font-weight: 600;
      padding: 0 14px;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.15s ease;
    }

    .operator-actions button:active {
      transform: scale(0.98);
    }

    .operator-actions button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .operator-actions button.primary {
      background: var(--primary);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 6px 14px rgba(31, 75, 153, 0.25);
    }

    .operator-footer {
      font-size: 12px;
      color: var(--text-muted);
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 50;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-card {
      width: min(520px, 100%);
      background: var(--surface);
      border-radius: 18px;
      padding: 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .modal-card h4 {
      margin: 0;
      font-size: 18px;
    }

    .modal-card select,
    .modal-card textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      font-size: 14px;
      background: var(--surface);
      color: var(--text);
      font-family: inherit;
    }

    .modal-card textarea {
      min-height: 90px;
      resize: vertical;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }

    .modal-actions button {
      height: 44px;
      min-height: 44px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface-muted);
      color: var(--text);
      font-size: 14px;
      font-weight: 600;
      padding: 0 16px;
      cursor: pointer;
    }

    .modal-actions button.primary {
      background: var(--primary);
      color: #fff;
      border-color: transparent;
    }

    .tab-bar {
      position: fixed;
      top: var(--header-height);
      left: 0;
      right: 0;
      height: var(--tabbar-height);
      background: var(--surface);
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      padding: 6px 16px 10px;
      border-bottom: 1px solid var(--border);
      box-shadow: 0 8px 20px rgba(21, 32, 51, 0.1);
      z-index: 15;
      align-items: center;
    }

    .tab-button {
      position: relative;
      height: 44px;
      min-height: 44px;
      border-radius: 12px;
      border: 1px solid transparent;
      font-size: 14px;
      font-weight: 600;
      background: var(--surface-muted);
      color: var(--text);
      transition: transform 0.1s ease, background 0.15s ease, border-color 0.15s ease;
      overflow: hidden;
      padding: 0 8px;
    }

    .tab-button:active,
    .tab-button.pressed {
      transform: scale(0.98);
    }

    .tab-button.active {
      background: var(--primary);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 6px 16px rgba(31, 75, 153, 0.3);
    }

    body[data-theme="high-contrast"] .tab-button.active {
      color: #111;
      box-shadow: 0 0 0 3px rgba(255, 216, 74, 0.45);
    }

    .tab-button:focus-visible {
      outline: 3px solid var(--focus);
      outline-offset: 3px;
    }

    .tab-button.halo::after {
      content: "";
      position: absolute;
      inset: 4px;
      border-radius: 12px;
      border: 2px solid var(--focus);
      opacity: 0.9;
      animation: halo 0.35s ease-out;
      pointer-events: none;
    }

    .tab-button .ripple {
      position: absolute;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.6) 0%, rgba(255, 255, 255, 0) 70%);
      transform: translate(-50%, -50%);
      animation: ripple 0.45s ease-out;
      pointer-events: none;
      opacity: 0.9;
    }

    body[data-theme="high-contrast"] .tab-button .ripple {
      background: radial-gradient(circle, rgba(255, 216, 74, 0.7) 0%, rgba(255, 216, 74, 0) 70%);
    }

    .toggle {
      margin-top: 16px;
      display: flex;
      align-items: center;
      gap: 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      max-width: 420px;
    }

    .toggle span {
      font-size: 16px;
      font-weight: 600;
    }

    .switch {
      position: relative;
      width: 60px;
      height: 32px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      inset: 0;
      background: var(--surface-muted);
      border: 1px solid var(--border);
      border-radius: 999px;
      transition: background 0.2s ease, border-color 0.2s ease;
    }

    .slider::after {
      content: "";
      position: absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--surface);
      box-shadow: var(--shadow);
      transition: transform 0.2s ease;
    }

    .switch input:checked + .slider {
      background: var(--primary);
      border-color: transparent;
    }

    .switch input:checked + .slider::after {
      transform: translateX(26px);
    }

    .switch input:focus-visible + .slider {
      outline: 3px solid var(--focus);
      outline-offset: 3px;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(6px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes halo {
      from {
        opacity: 0.9;
        transform: scale(0.96);
      }
      to {
        opacity: 0;
        transform: scale(1.04);
      }
    }

    @keyframes ripple {
      from {
        transform: translate(-50%, -50%) scale(0.2);
        opacity: 0.8;
      }
      to {
        transform: translate(-50%, -50%) scale(1);
        opacity: 0;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Maquette SMED</h1>
    <p class="subtitle-line">
      <span>Offline, tactile, V1 |</span>
      <span class="datetime-inline" aria-live="polite">
        <span id="header-datetime">--:-- – --/--/----</span>
      </span>
    </p>
  </header>

  <nav class="tab-bar" aria-label="Navigation des pages">
    <button class="tab-button active" type="button" data-target="smed" aria-current="page">SMED</button>
    <button class="tab-button" type="button" data-target="analyse">Analyse</button>
    <button class="tab-button" type="button" data-target="parametres">Paramètres</button>
  </nav>

  <main>
    <section class="page active" id="page-smed" data-tab="smed">
      <!-- Bloc d’identification (affichage uniquement). -->
      <div class="id-block">
        <div class="field wide ligne">
          <label for="ligne-input">Ligne</label>
          <input id="ligne-input" type="text" placeholder="Saisir la ligne">
        </div>
        <div class="field wide po">
          <label for="po-input">PO</label>
          <input id="po-input" type="text" placeholder="Saisir le PO">
        </div>
        <div class="field date">
          <label for="ipc-date">Date IPC</label>
          <input id="ipc-date" type="date" aria-label="Dernier IPC - date">
        </div>
        <div class="field time">
          <label for="ipc-time">Heure IPC</label>
          <input id="ipc-time" type="time" aria-label="Dernier IPC - heure" step="60">
        </div>
        <div class="field actions-field">
          <label for="reset-smed">Reset</label>
          <div class="actions-wrap">
            <button id="reset-smed" class="reset-button" type="button">Reset</button>
          </div>
        </div>
      </div>
      <section class="chrono-bar" id="global-chrono-bar">
        <div class="chrono-card state-ok" id="chrono-card" aria-live="polite">
          <div class="chrono-main">
            <span class="chrono-label">Chronomètre</span>
            <span class="chrono-time" id="chrono-time">00:00</span>
            <span class="chrono-status" id="chrono-status">EN ATTENTE</span>
          </div>
          <div class="chrono-metrics">
            <div class="chrono-metric">
              Cible
              <span>61.0 min</span>
            </div>
            <div class="chrono-metric">
              Alerte
              <span>12.0 min</span>
            </div>
          </div>
        </div>
      </section>
      <div id="smed-started" class="inline-status" role="status" aria-live="polite">
        <span class="dot" aria-hidden="true"></span>
        <span>Le changement de production a démarré</span>
      </div>
      <div class="operators-section">
        <h3>Étapes du changement</h3>
        <div id="operators-grid" class="operators-grid"></div>
      </div>
    </section>

    <section class="page" id="page-analyse" data-tab="analyse">
      <h2>Analyse</h2>
    </section>

    <section class="page" id="page-parametres" data-tab="parametres">
      <h2>Paramètres</h2>
      <div class="toggle" aria-live="polite">
        <span>Contraste élevé</span>
        <label class="switch">
          <input id="contrast-toggle" type="checkbox" aria-label="Activer le contraste élevé">
          <span class="slider"></span>
        </label>
      </div>
    </section>
  </main>
  <div class="modal-overlay" id="justification-modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card">
      <h4>Justification requise</h4>
      <p>Temps dépassé. Sélectionne une raison.</p>
      <label for="justification-reason">Raison</label>
      <select id="justification-reason">
        <option value="">Sélectionner</option>
      </select>
      <div id="justification-other-wrapper" hidden>
        <label for="justification-other">Autre</label>
        <textarea id="justification-other" placeholder="Décrire la raison..."></textarea>
      </div>
      <div class="modal-actions">
        <button type="button" id="justification-cancel">Annuler</button>
        <button type="button" id="justification-confirm" class="primary">Valider</button>
      </div>
    </div>
  </div>

  <script>
    // Navigation par onglets + état actif.
    const buttons = document.querySelectorAll(".tab-button");
    const pages = document.querySelectorAll(".page");
    const contrastToggle = document.querySelector("#contrast-toggle");
    const headerDateTime = document.querySelector("#header-datetime");
    const ipcDate = document.querySelector("#ipc-date");
    const ipcTime = document.querySelector("#ipc-time");
    const resetSmedButton = document.querySelector("#reset-smed");
    const chronoCard = document.querySelector("#chrono-card");
    const chronoTime = document.querySelector("#chrono-time");
    const chronoStatus = document.querySelector("#chrono-status");
    const smedStarted = document.querySelector("#smed-started");
    const operatorsGrid = document.querySelector("#operators-grid");
    const justificationModal = document.querySelector("#justification-modal");
    const justificationReason = document.querySelector("#justification-reason");
    const justificationOtherWrapper = document.querySelector("#justification-other-wrapper");
    const justificationOther = document.querySelector("#justification-other");
    const justificationCancel = document.querySelector("#justification-cancel");
    const justificationConfirm = document.querySelector("#justification-confirm");

    const setActiveTab = (target) => {
      buttons.forEach((button) => {
        const isActive = button.dataset.target === target;
        button.classList.toggle("active", isActive);
        if (isActive) {
          button.setAttribute("aria-current", "page");
        } else {
          button.removeAttribute("aria-current");
        }
      });
      pages.forEach((page) => {
        page.classList.toggle("active", page.dataset.tab === target);
      });
    };

    // Retour visuel tactile renforcé (pressed + halo + ripple).
    const addRipple = (button, event) => {
      const rect = button.getBoundingClientRect();
      const ripple = document.createElement("span");
      ripple.className = "ripple";
      ripple.style.left = `${event.clientX - rect.left}px`;
      ripple.style.top = `${event.clientY - rect.top}px`;
      button.appendChild(ripple);
      ripple.addEventListener("animationend", () => ripple.remove());
    };

    buttons.forEach((button) => {
      button.addEventListener("click", () => {
        setActiveTab(button.dataset.target);
      });

      button.addEventListener("pointerdown", (event) => {
        button.classList.add("pressed", "halo");
        addRipple(button, event);
      });

      const clearPress = () => button.classList.remove("pressed", "halo");
      button.addEventListener("pointerup", clearPress);
      button.addEventListener("pointerleave", clearPress);
      button.addEventListener("pointercancel", clearPress);
    });

    // Contraste élevé (mémoire uniquement, sans stockage).
    if (contrastToggle) {
      contrastToggle.addEventListener("change", (event) => {
        document.body.dataset.theme = event.target.checked ? "high-contrast" : "";
      });
    }

    // Démarrage SMED: date + heure du "Dernier IPC" renseignées.
    let isSmedStarted = false;
    let wasSmedStarted = false;
    let startedToastTimeout = null;
    let chronoInterval = null;
    let chronoStartTimestamp = null;
    let elapsedSeconds = 0;
    const targetSeconds = 61 * 60;
    const reasons = [
      "Manque de matière",
      "Problème machine",
      "Attente qualité",
      "Réglage complémentaire",
      "Changement d'outil",
      "Autre"
    ];

    const operatorsTemplateSteps = [
      { label: "Action 1", targetMin: 5.0 },
      { label: "Action 2", targetMin: 5.0 },
      { label: "Action 3", targetMin: 5.0 },
      { label: "Action 4", targetMin: 5.0 },
      { label: "Action 5", targetMin: 5.0 }
    ];

    let operators = [
      { id: "op1", name: "Opérateur 1", currentStepIndex: 0, stepStatus: "todo", stepStartTimestamp: null, elapsedSeconds: 0, actualMin: null, steps: operatorsTemplateSteps },
      { id: "op2", name: "Opérateur 2", currentStepIndex: 0, stepStatus: "todo", stepStartTimestamp: null, elapsedSeconds: 0, actualMin: null, steps: operatorsTemplateSteps },
      { id: "op3", name: "Opérateur 3", currentStepIndex: 0, stepStatus: "todo", stepStartTimestamp: null, elapsedSeconds: 0, actualMin: null, steps: operatorsTemplateSteps }
    ];

    let operatorInterval = null;
    let pendingJustification = null;

    const resetOperators = () => {
      operators = operators.map((operator) => ({
        ...operator,
        currentStepIndex: 0,
        stepStatus: "todo",
        stepStartTimestamp: null,
        elapsedSeconds: 0,
        actualMin: null
      }));
      if (operatorInterval) {
        clearInterval(operatorInterval);
        operatorInterval = null;
      }
      renderOperators();
    };

    const startOperatorTick = () => {
      if (operatorInterval) {
        return;
      }
      operatorInterval = setInterval(() => {
        if (!isSmedStarted) {
          return;
        }
        let didUpdate = false;
        operators.forEach((operator) => {
          if (operator.stepStatus === "running" && operator.stepStartTimestamp) {
            operator.elapsedSeconds = Math.floor((Date.now() - operator.stepStartTimestamp) / 1000);
            didUpdate = true;
          }
        });
        if (didUpdate) {
          renderOperators();
        }
      }, 1000);
    };

    const startAllOperatorsOnSmedStart = () => {
      operators.forEach((operator) => {
        if (operator.currentStepIndex < operator.steps.length) {
          operator.stepStatus = "running";
          operator.stepStartTimestamp = Date.now();
          operator.elapsedSeconds = 0;
          operator.actualMin = null;
        }
      });
      startOperatorTick();
      renderOperators();
    };

    const getOperatorStatusLabel = (operator) => {
      if (operator.currentStepIndex >= operator.steps.length) {
        return { label: "Terminé", className: "done" };
      }
      if (operator.stepStatus === "running") {
        return { label: "En cours", className: "running" };
      }
      if (operator.stepStatus === "over") {
        return { label: "Dépassé", className: "over" };
      }
      return { label: "À faire", className: "todo" };
    };

    const formatMinutes = (seconds) => (Math.round((seconds / 60) * 10) / 10).toFixed(1);

    const renderOperators = () => {
      if (!operatorsGrid) {
        return;
      }
      operatorsGrid.innerHTML = "";
      operators.forEach((operator) => {
        const status = getOperatorStatusLabel(operator);
        const isDone = operator.currentStepIndex >= operator.steps.length;
        const step = operator.steps[operator.currentStepIndex];
        const stepLabel = step ? step.label : "Toutes les étapes";
        const targetMin = step ? step.targetMin.toFixed(1) : "--";
        const actualMin = operator.actualMin !== null ? operator.actualMin.toFixed(1) : "--";
        const disabled = !isSmedStarted || isDone;

        const canValidate = isSmedStarted && operator.stepStatus === "running" && !isDone;
        const card = document.createElement("div");
        card.className = `operator-card ${!isSmedStarted ? "inactive" : ""}`;
        card.dataset.status = status.className;
        card.innerHTML = `
          <div class="operator-header">
            <div class="operator-name">${operator.name}</div>
            <div class="operator-status ${status.className}">${status.label}</div>
          </div>
          <div class="operator-step">
            <strong>${stepLabel}</strong>
            <span>Étape ${Math.min(operator.currentStepIndex + 1, operator.steps.length)} / ${operator.steps.length}</span>
          </div>
          <div class="operator-chips">
            <span class="chip">Cible: ${targetMin} min</span>
            <span class="chip ${actualMin === "--" ? "muted" : ""}">Réel: ${actualMin} min</span>
          </div>
          <div class="operator-actions">
            <button class="primary" data-action="validate" data-op="${operator.id}" ${canValidate ? "" : "disabled"}>Valider</button>
          </div>
          <div class="operator-footer">Chrono étape: ${formatMinutes(operator.elapsedSeconds)} min</div>
        `;
        operatorsGrid.appendChild(card);
      });
    };

    const openJustificationModal = (payload) => {
      pendingJustification = payload;
      if (justificationModal) {
        justificationModal.classList.add("active");
        justificationModal.setAttribute("aria-hidden", "false");
      }
    };

    const closeJustificationModal = () => {
      pendingJustification = null;
      if (justificationModal) {
        justificationModal.classList.remove("active");
        justificationModal.setAttribute("aria-hidden", "true");
      }
      if (justificationReason) {
        justificationReason.value = "";
      }
      if (justificationOther) {
        justificationOther.value = "";
      }
      if (justificationOtherWrapper) {
        justificationOtherWrapper.hidden = true;
      }
    };

    const completeStep = (operator, actualMin, isOver) => {
      operator.actualMin = actualMin;
      operator.stepStatus = isOver ? "over" : "done";
      operator.stepStartTimestamp = null;
      operator.elapsedSeconds = 0;
      operator.currentStepIndex += 1;
      if (operator.currentStepIndex >= operator.steps.length) {
        operator.stepStatus = "done";
      } else if (isSmedStarted) {
        operator.stepStatus = "running";
        operator.stepStartTimestamp = Date.now();
        operator.elapsedSeconds = 0;
        operator.actualMin = null;
      } else {
        operator.stepStatus = "todo";
      }
      renderOperators();
    };

    const handleValidate = (operator) => {
      if (operator.stepStatus !== "running") {
        return;
      }
      const step = operator.steps[operator.currentStepIndex];
      const actualMinValue = Number(formatMinutes(operator.elapsedSeconds));
      const isOver = actualMinValue > step.targetMin;
      if (isOver) {
        openJustificationModal({ operatorId: operator.id, actualMin: actualMinValue });
        return;
      }
      completeStep(operator, actualMinValue, false);
    };

    const initializeReasons = () => {
      if (!justificationReason) {
        return;
      }
      justificationReason.innerHTML = '<option value="">Sélectionner</option>';
      reasons.forEach((reason) => {
        const option = document.createElement("option");
        option.value = reason;
        option.textContent = reason;
        justificationReason.appendChild(option);
      });
    };

    const formatTime = (totalSeconds) => {
      const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, "0");
      const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, "0");
      return `${hours}:${minutes}`;
    };

    const updateChronoDisplay = () => {
      if (!chronoCard || !chronoTime || !chronoStatus) {
        return;
      }
      const progress = Math.min(elapsedSeconds / targetSeconds, 1);
      chronoCard.style.setProperty("--chrono-progress", progress);
      chronoTime.textContent = formatTime(elapsedSeconds);

      let stateClass = "state-ok";
      if (progress >= 1) {
        stateClass = "state-over";
      } else if (progress >= 0.7) {
        stateClass = "state-warn";
      }

      chronoCard.classList.remove("state-ok", "state-warn", "state-over");
      chronoCard.classList.add(stateClass);

      if (!isSmedStarted) {
        chronoStatus.textContent = "EN ATTENTE";
      } else if (elapsedSeconds >= targetSeconds) {
        chronoStatus.textContent = "DEPASSEMENT";
      } else {
        chronoStatus.textContent = "EN COURS";
      }
    };

    const startChrono = () => {
      if (chronoInterval) {
        return;
      }
      chronoStartTimestamp = Date.now() - elapsedSeconds * 1000;
      chronoInterval = setInterval(() => {
        elapsedSeconds = Math.floor((Date.now() - chronoStartTimestamp) / 1000);
        updateChronoDisplay();
      }, 1000);
      updateChronoDisplay();
    };

    const stopChrono = (reset = false) => {
      if (chronoInterval) {
        clearInterval(chronoInterval);
        chronoInterval = null;
      }
      if (reset) {
        elapsedSeconds = 0;
        chronoStartTimestamp = null;
      }
      updateChronoDisplay();
    };

    const updateSmedStarted = () => {
      const hasDate = Boolean(ipcDate && ipcDate.value);
      const hasTime = Boolean(ipcTime && ipcTime.value);
      const newIsSmedStarted = hasDate && hasTime;
      isSmedStarted = newIsSmedStarted;
      if (smedStarted && !newIsSmedStarted) {
        smedStarted.classList.remove("visible");
      }
      if (!newIsSmedStarted && startedToastTimeout) {
        clearTimeout(startedToastTimeout);
        startedToastTimeout = null;
      }
      if (!wasSmedStarted && newIsSmedStarted && smedStarted) {
        if (startedToastTimeout) {
          clearTimeout(startedToastTimeout);
          startedToastTimeout = null;
        }
        smedStarted.classList.add("visible");
        startedToastTimeout = setTimeout(() => {
          smedStarted.classList.remove("visible");
          startedToastTimeout = null;
        }, 5000);
        startAllOperatorsOnSmedStart();
      }
      if (isSmedStarted) {
        startChrono();
        startOperatorTick();
      } else {
        stopChrono(true);
      }
      wasSmedStarted = newIsSmedStarted;
      renderOperators();
    };

    if (ipcDate && ipcTime) {
      ipcDate.addEventListener("input", updateSmedStarted);
      ipcTime.addEventListener("input", updateSmedStarted);
    }

    if (operatorsGrid) {
      operatorsGrid.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        const action = target.dataset.action;
        const opId = target.dataset.op;
        if (!action || !opId) {
          return;
        }
        const operator = operators.find((item) => item.id === opId);
        if (!operator) {
          return;
        }
        if (action === "validate") {
          handleValidate(operator);
        }
      });
    }

    if (justificationReason) {
      justificationReason.addEventListener("change", () => {
        if (!justificationOtherWrapper || !justificationOther) {
          return;
        }
        const isOther = justificationReason.value === "Autre";
        justificationOtherWrapper.hidden = !isOther;
        if (!isOther) {
          justificationOther.value = "";
        }
      });
    }

    if (justificationCancel) {
      justificationCancel.addEventListener("click", () => {
        closeJustificationModal();
      });
    }

    if (justificationConfirm) {
      justificationConfirm.addEventListener("click", () => {
        if (!pendingJustification) {
          closeJustificationModal();
          return;
        }
        if (!justificationReason) {
          return;
        }
        const selectedReason = justificationReason.value;
        if (!selectedReason) {
          return;
        }
        if (selectedReason === "Autre" && (!justificationOther || !justificationOther.value.trim())) {
          return;
        }
        const operator = operators.find((item) => item.id === pendingJustification.operatorId);
        if (operator) {
          completeStep(operator, pendingJustification.actualMin, true);
        }
        closeJustificationModal();
      });
    }

    if (resetSmedButton) {
      resetSmedButton.addEventListener("click", () => {
        const shouldReset = window.confirm("Confirmer la remise à zéro du SMED ?");
        if (!shouldReset) {
          return;
        }
        if (ipcDate) {
          ipcDate.value = "";
        }
        if (ipcTime) {
          ipcTime.value = "";
        }
        const ligneInput = document.querySelector("#ligne-input");
        const poInput = document.querySelector("#po-input");
        if (ligneInput) {
          ligneInput.value = "";
        }
        if (poInput) {
          poInput.value = "";
        }
        isSmedStarted = false;
        wasSmedStarted = false;
        if (startedToastTimeout) {
          clearTimeout(startedToastTimeout);
          startedToastTimeout = null;
        }
        if (smedStarted) {
          smedStarted.classList.remove("visible");
        }
        resetOperators();
        updateSmedStarted();
      });
    }

    // Date/heure en direct (locale fr-FR, mise à jour chaque seconde).
    const updateDateTime = () => {
      if (!headerDateTime) {
        return;
      }
      const now = new Date();
      const time = now.toLocaleTimeString("fr-FR", {
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      });
      const date = now.toLocaleDateString("fr-FR");
      headerDateTime.textContent = `${time} – ${date}`;
    };

    updateDateTime();
    setInterval(updateDateTime, 1000);
    updateSmedStarted();
    initializeReasons();
    renderOperators();
  </script>
</body>
</html>
